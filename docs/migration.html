<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Loki4j Migration Guide · Loki4j Logback</title><meta name="viewport" content="width=device-width, initial-scale=1.0"/><meta name="generator" content="Docusaurus"/><meta name="description" content="## Upgrading from 1.3.x to 1.4.x"/><meta name="docsearch:language" content="en"/><meta property="og:title" content="Loki4j Migration Guide · Loki4j Logback"/><meta property="og:type" content="website"/><meta property="og:url" content="https://loki4j.github.io/loki-logback-appender/"/><meta property="og:description" content="## Upgrading from 1.3.x to 1.4.x"/><meta property="og:image" content="https://loki4j.github.io/loki-logback-appender/img/undraw_online.svg"/><meta name="twitter:card" content="summary"/><meta name="twitter:image" content="https://loki4j.github.io/loki-logback-appender/img/undraw_tweetstorm.svg"/><link rel="shortcut icon" href="/loki-logback-appender/img/logo-lite.svg"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-0Z4FEXM003"></script><script>
              window.dataLayer = window.dataLayer || [];
              function gtag(){dataLayer.push(arguments); }
              gtag('js', new Date());
              gtag('config', 'G-0Z4FEXM003');
            </script><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script src="/loki-logback-appender/js/scrollSpy.js"></script><link rel="stylesheet" href="/loki-logback-appender/css/main.css"/><script src="/loki-logback-appender/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/loki-logback-appender/"><img class="logo" src="/loki-logback-appender/img/logo-gray.svg" alt="Loki4j Logback"/><h2 class="headerTitleWithLogo">Loki4j Logback</h2></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class="siteNavGroupActive"><a href="/loki-logback-appender/docs/configuration" target="_self">Docs</a></li><li class=""><a href="https://github.com/loki4j/loki-logback-appender/blob/main/CONTRIBUTING.md" target="_self">Contributing</a></li><li class=""><a href="/loki-logback-appender/help" target="_self">Help</a></li><li class=""><a href="https://github.com/loki4j/loki-logback-appender" target="_self">GitHub</a></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><div class="hamburger-menu"><div class="line1"></div><div class="line2"></div><div class="line3"></div></div></div><h2><i>›</i><span>Logback</span></h2><div class="tocToggler" id="tocToggler"><i class="icon-toc"></i></div></div><div class="navGroups"><div class="navGroup"><h3 class="navGroupCategoryTitle">Logback</h3><ul class=""><li class="navListItem"><a class="navItem" href="/loki-logback-appender/docs/configuration">Configuration</a></li><li class="navListItem"><a class="navItem" href="/loki-logback-appender/docs/performance">Performance Monitoring</a></li><li class="navListItem"><a class="navItem" href="/loki-logback-appender/docs/tracing">Tracing</a></li><li class="navListItem navListItemActive"><a class="navItem" href="/loki-logback-appender/docs/migration">Migration Guide</a></li><li class="navListItem"><a class="navItem" href="/loki-logback-appender/docs/olddocs">Old Docs</a></li></ul></div></div></section></div><script>
            var coll = document.getElementsByClassName('collapsible');
            var checkActiveCategory = true;
            for (var i = 0; i < coll.length; i++) {
              var links = coll[i].nextElementSibling.getElementsByTagName('*');
              if (checkActiveCategory){
                for (var j = 0; j < links.length; j++) {
                  if (links[j].classList.contains('navListItemActive')){
                    coll[i].nextElementSibling.classList.toggle('hide');
                    coll[i].childNodes[1].classList.toggle('rotate');
                    checkActiveCategory = false;
                    break;
                  }
                }
              }

              coll[i].addEventListener('click', function() {
                var arrow = this.childNodes[1];
                arrow.classList.toggle('rotate');
                var content = this.nextElementSibling;
                content.classList.toggle('hide');
              });
            }

            document.addEventListener('DOMContentLoaded', function() {
              createToggler('#navToggler', '#docsNav', 'docsSliderActive');
              createToggler('#tocToggler', 'body', 'tocActive');

              var headings = document.querySelector('.toc-headings');
              headings && headings.addEventListener('click', function(event) {
                var el = event.target;
                while(el !== headings){
                  if (el.tagName === 'A') {
                    document.body.classList.remove('tocActive');
                    break;
                  } else{
                    el = el.parentNode;
                  }
                }
              }, false);

              function createToggler(togglerSelector, targetSelector, className) {
                var toggler = document.querySelector(togglerSelector);
                var target = document.querySelector(targetSelector);

                if (!toggler) {
                  return;
                }

                toggler.onclick = function(event) {
                  event.preventDefault();

                  target.classList.toggle(className);
                };
              }
            });
        </script></nav></div><div class="container mainContainer docsContainer"><div class="wrapper"><div class="post"><header class="postHeader"><h1 id="__docusaurus" class="postHeaderTitle">Loki4j Migration Guide</h1></header><article><div><span><h2><a class="anchor" aria-hidden="true" id="upgrading-from-13x-to-14x"></a><a href="#upgrading-from-13x-to-14x" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Upgrading from 1.3.x to 1.4.x</h2>
<p>Version 1.4.0 contains several new features that may break the existing behavior for some users.
Please see below for the details.</p>
<h4><a class="anchor" aria-hidden="true" id="separate-protobuf-jar"></a><a href="#separate-protobuf-jar" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Separate Protobuf JAR</h4>
<p>If you use Protobuf format, now you need to add a new dependency to your project:</p>
<pre><code class="hljs css language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.github.loki4j<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>loki-protobuf<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.0.1_pbX.Y.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p>A part <code>_pbX.Y.0</code> in version means that now you can use any supported PB version by substituting it here.
E.g. for Protobuf v3.21.x it should be <code>_pb3.21.0</code>.</p>
<p>In previous versions of Loki4j you were required to add <code>protobuf-java</code> and <code>snappy-java</code> as dependencies to you project.
In 1.4.0 it's no longer required as the proper versions of these libs come as transitive dependencies of <code>loki-protobuf</code>.</p>
<h4><a class="anchor" aria-hidden="true" id="retry-functionality-added"></a><a href="#retry-functionality-added" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Retry functionality added</h4>
<p>Loki4j is designed to operate in presence of various errors and connection failures returned from Loki.
However, the previous versions tried to send each log batch only once, so all batches sent during
unavailability of Loki are lost.</p>
<p>In 1.4.0 Loki4j can try to send a log batch to Loki again, if the previous attempt failed.
Please note, that re-send is done only in case of <code>ConnectException</code> or <code>503</code> HTTP status from Loki.
All other exceptions as well as 4xx-5xx statuses are not retried in order to avoid duplicates.</p>
<h4><a class="anchor" aria-hidden="true" id="deprecated-batchsize-setting-is-removed"></a><a href="#deprecated-batchsize-setting-is-removed" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Deprecated &quot;batchSize&quot; setting is removed</h4>
<p>The <code>batchSize</code> setting was renamed to <code>batchMaxItems</code> back in 1.2.0, but you still could use the old name until 1.4.0.
Now the old name support was completely dropped, so please make sure you use <code>batchMaxItems</code> instead.</p>
<h2><a class="anchor" aria-hidden="true" id="upgrading-from-12x-to-13x"></a><a href="#upgrading-from-12x-to-13x" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Upgrading from 1.2.x to 1.3.x</h2>
<p>Version 1.3.0 was focused on internal refactoring and bug fixing.
For most users 1.3.0 could be used as a drop-in replacement of 1.2.0.</p>
<p>The only breaking change that could affect these who use Loki4j performance metrics
is that the tag <code>host</code> is no longer hardcoded for all the reported Loki4j metrics.
This hardcoding was redundant as you always can set up <code>host</code> tag for any metric in your custom
Micrometer config on the application level.</p>
<h2><a class="anchor" aria-hidden="true" id="upgrading-from-11x-to-12x"></a><a href="#upgrading-from-11x-to-12x" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Upgrading from 1.1.x to 1.2.x</h2>
<p>The development for version 1.2.0 was mostly concentrated around performance and memory usage.
Let's discuss how these changes affect the configuration in <code>logback.xml</code>.</p>
<h4><a class="anchor" aria-hidden="true" id="limitation-for-a-batch-length-in-bytes-added"></a><a href="#limitation-for-a-batch-length-in-bytes-added" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Limitation for a batch length (in bytes) added</h4>
<p>Previously there was no option to limit a batch size in bytes, and in case of large log messages this could
lead to <code>grpc: received message larger than max</code> error from Loki followed by the drop of this entire batch.</p>
<p>In 1.2.0 you can control the batch size using a new property <code>batchMaxBytes</code>:</p>
<pre><code class="hljs css language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">appender</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"LOKI"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.github.loki4j.logback.Loki4jAppender"</span>&gt;</span>
    ...
    <span class="hljs-tag">&lt;<span class="hljs-name">batchMaxBytes</span>&gt;</span>4194304<span class="hljs-tag">&lt;/<span class="hljs-name">batchMaxBytes</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">appender</span>&gt;</span>
</code></pre>
<p>Important note.
Loki limits max message size in bytes by comparing its size in uncompressed Protobuf format to a
value of setting <code>grpc_server_max_recv_msg_size</code>. That's why Loki4j's <code>batchMaxBytes</code>
setting should be less or equal than Loki's <code>grpc_server_max_recv_msg_size</code> setting (by default it's 4 MB).</p>
<p>The above statement also means that Loki4j batching based on <code>batchMaxBytes</code> does not depend
on the format Loki4j sends a batch in (JSON, compressed Protobuf). The <em>real</em> size of HTTP body
can vary. Loki4j only tries to estimate the size of the batch as if it was in uncompressed Protobuf
format (without actually encoding it), and make sure this approximate size never to be less than
an actual size as counted by Loki.</p>
<h4><a class="anchor" aria-hidden="true" id="batchsize-property-renamed-to-batchmaxitems"></a><a href="#batchsize-property-renamed-to-batchmaxitems" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><code>batchSize</code> property renamed to <code>batchMaxItems</code></h4>
<p>After introducing new <code>batchMaxBytes</code> setting (see the previous section), the existing
<code>batchSize</code> setting was renamed to <code>batchMaxItems</code> for consistency.</p>
<p>If you used <code>batchSize</code> in you configuration for previous versions of Loki4j, make sure
you've change it to <code>batchMaxItems</code> while upgrading to 1.2.0.</p>
<h4><a class="anchor" aria-hidden="true" id="switch-to-non-blocking-and-non-allocating-send-queue"></a><a href="#switch-to-non-blocking-and-non-allocating-send-queue" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Switch to non-blocking and non-allocating send queue</h4>
<p>In version 1.1.0 the backpressure mechanism was introduced. Sender queue was based on <code>ArrayBlockingQueue</code> and it
could be limited only by max number of batches in the queue using <code>sendQueueSize</code> setting.</p>
<p>In 1.2.0 this implementation was replaced by non-blocking <code>ConcurrentLinkedQueue</code> of <code>ByteBuffers</code>.
Now the sender queue could be limited by max size in bytes, so you now can control the memory consumption
more precisely. <code>sendQueueSize</code> setting is replaced with <code>sendQueueMaxBytes</code>:</p>
<pre><code class="hljs css language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">appender</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"LOKI"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.github.loki4j.logback.Loki4jAppender"</span>&gt;</span>
    ...
    <span class="hljs-tag">&lt;<span class="hljs-name">sendQueueMaxBytes</span>&gt;</span>41943040<span class="hljs-tag">&lt;/<span class="hljs-name">sendQueueMaxBytes</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">appender</span>&gt;</span>
</code></pre>
<h4><a class="anchor" aria-hidden="true" id="encoders-and-send-queue-now-use-bytebuffers"></a><a href="#encoders-and-send-queue-now-use-bytebuffers" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Encoders and send queue now use ByteBuffers</h4>
<p>This means that now you can switch between off-heap (i.e. direct) and on-heap buffers:</p>
<pre><code class="hljs css language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">appender</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"LOKI"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.github.loki4j.logback.Loki4jAppender"</span>&gt;</span>
    ...
    <span class="hljs-tag">&lt;<span class="hljs-name">useDirectBuffers</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">useDirectBuffers</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">appender</span>&gt;</span>
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="upgrading-from-10x-to-11x"></a><a href="#upgrading-from-10x-to-11x" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Upgrading from 1.0.x to 1.1.x</h2>
<p>Version 1.1.0 introduces several changes to how the appender behaves and how it is configured in <code>logback.xml</code>.</p>
<h4><a class="anchor" aria-hidden="true" id="backpressure-mechanism-added"></a><a href="#backpressure-mechanism-added" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Backpressure mechanism added</h4>
<p>Before 1.1.0 if the appender sended log batches to Loki slower than they are produced by the application,
unsent batches were accumulated in the sender's execution queue. This led to unpredictable memory consumption and OOMs.</p>
<p>Version 1.1.0 introduces an explicit setting for sender's queue size. Now any extra log records arrived being dropped
without encoding or any other processing. You can change this setting in the <code>logback.xml</code>:</p>
<pre><code class="hljs css language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">appender</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"LOKI"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.github.loki4j.logback.Loki4jAppender"</span>&gt;</span>
    ...
    <span class="hljs-tag">&lt;<span class="hljs-name">sendQueueSize</span>&gt;</span>50000<span class="hljs-tag">&lt;/<span class="hljs-name">sendQueueSize</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">appender</span>&gt;</span>
</code></pre>
<p>Dropped events are logged in Loki4j log (stderr) and reported via <code>loki4j.drop.events</code> metric.
If you see events are dropped in spikes, consider increasing <code>sendQueueSize</code>.</p>
<h4><a class="anchor" aria-hidden="true" id="drain-on-stop-behavior-changed"></a><a href="#drain-on-stop-behavior-changed" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Drain on stop behavior changed</h4>
<p>Loki4j has graceful shutdown procedure: when <code>stop()</code> is called it stops to accept new log events
and tries to drain unprocessed log events, so they are sent to Loki before processing pipeline is stopped.</p>
<p>Before 1.1.0 the appender waited for drain to complete for 500ms and then used to shutdown the
processing pipeline anyway.</p>
<p>Now this behavior is configurable using <code>drainOnStop</code> setting. If this setting is enabled the appender
will wait until all unsent events are processed whatever it takes. This is the default option.
You can disable this behavior in your <code>logback.xml</code>:</p>
<pre><code class="hljs css language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">appender</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"LOKI"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.github.loki4j.logback.Loki4jAppender"</span>&gt;</span>
    ...
    <span class="hljs-tag">&lt;<span class="hljs-name">drainOnStop</span>&gt;</span>false<span class="hljs-tag">&lt;/<span class="hljs-name">drainOnStop</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">appender</span>&gt;</span>
</code></pre>
<p>In this case the appender will shutdown immediately, all unsent events will be lost.</p>
<h4><a class="anchor" aria-hidden="true" id="metrics-configuration-changed"></a><a href="#metrics-configuration-changed" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Metrics configuration changed</h4>
<p>Previously it was required to switch to <code>InstrumentedLoki4jAppender</code> in order to enable the metrics.
Now it's done using <code>metricsEnabled</code> setting in <code>Loki4jAppender</code>:</p>
<pre><code class="hljs css language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">appender</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"LOKI"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.github.loki4j.logback.Loki4jAppender"</span>&gt;</span>
    ...
    <span class="hljs-tag">&lt;<span class="hljs-name">metricsEnabled</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">metricsEnabled</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">appender</span>&gt;</span>
</code></pre>
<p><code>InstrumentedLoki4jAppender</code> does not exist anymore.</p>
<h4><a class="anchor" aria-hidden="true" id="threadpool-related-settings-are-removed"></a><a href="#threadpool-related-settings-are-removed" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ThreadPool-related settings are removed</h4>
<p>Since 1.1.0 Loki4j uses 3 dedicated threads for operating (encoder, sender, and scheduler).
Thus, the following settings were removed:</p>
<ul>
<li>processingThreads</li>
<li>http.httpThreads</li>
</ul>
<h2><a class="anchor" aria-hidden="true" id="upgrading-from-04x-to-10x"></a><a href="#upgrading-from-04x-to-10x" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Upgrading from 0.4.x to 1.0.x</h2>
<p>Version 1.0.0 introduces several significant changes to how the appender is configured in <code>logback.xml</code>.</p>
<h4><a class="anchor" aria-hidden="true" id="appender-class-name-changed"></a><a href="#appender-class-name-changed" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Appender class name changed</h4>
<p>In 0.4.x there were two appender classes <code>LokiJavaHttpAppender</code> and <code>LokiApacheHttpAppender</code> depending on which
underlying HTTP client should be used for sending data to Loki.
In 1.0.x HTTP client setting is pushed down to a separate section (see below) so there is only one main appender class:</p>
<pre><code class="hljs css language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">appender</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"LOKI"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.github.loki4j.logback.Loki4jAppender"</span>&gt;</span>
</code></pre>
<h4><a class="anchor" aria-hidden="true" id="new-sub-section-http"></a><a href="#new-sub-section-http" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>New sub-section <code>&lt;http&gt;</code></h4>
<p>In 1.0.x all HTTP-related settings were moved to a separate section <code>&lt;http&gt;</code>.
You can choose between Java- or Apache-backed HTTP sender via <code>class</code> attribute of <code>&lt;http&gt;</code>:</p>
<pre><code class="hljs css language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">http</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.github.loki4j.logback.JavaHttpSender"</span>&gt;</span>
</code></pre>
<p>or</p>
<pre><code class="hljs css language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">http</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.github.loki4j.logback.ApacheHttpSender"</span>&gt;</span>
</code></pre>
<p>If <code>class</code> is not specified <code>JavaHttpSender</code> is used.
Please note that only <code>ApacheHttpSender</code> is available for Java 8.</p>
<p>Below is the list of settings moved to <code>&lt;http&gt;</code> section (previously they were in <code>&lt;appender&gt;</code> section):</p>
<ul>
<li>url</li>
<li>connectionTimeoutMs</li>
<li>requestTimeoutMs</li>
</ul>
<p><code>ApacheHttpSender</code>-specific settings:</p>
<ul>
<li>maxConnections</li>
<li>connectionKeepAliveMs</li>
<li>httpThreads</li>
</ul>
<h4><a class="anchor" aria-hidden="true" id="encoder-sub-section-renamed-to-format"></a><a href="#encoder-sub-section-renamed-to-format" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Encoder sub-section renamed to <code>&lt;format&gt;</code></h4>
<p>In 1.0.0 <code>&lt;encoder&gt;</code> section was renamed to <code>&lt;format&gt;</code>.
Encoder classes and settings names for this section remain unchanged.</p>
<pre><code class="hljs css language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">format</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.github.loki4j.logback.JsonEncoder"</span>&gt;</span>
</code></pre>
<p>or</p>
<pre><code class="hljs css language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">format</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.github.loki4j.logback.ProtobufEncoder"</span>&gt;</span>
</code></pre>
<p>If <code>class</code> is not specified <code>JsonEncoder</code> is used.</p>
<h4><a class="anchor" aria-hidden="true" id="example"></a><a href="#example" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Example</h4>
<p>Given the following 0.4.x config:</p>
<pre><code class="hljs css language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">appender</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"LOKI"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.github.loki4j.logback.LokiApacheHttpAppender"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">url</span>&gt;</span>http://localhost:3100/loki/api/v1/push<span class="hljs-tag">&lt;/<span class="hljs-name">url</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">requestTimeoutMs</span>&gt;</span>15000<span class="hljs-tag">&lt;/<span class="hljs-name">requestTimeoutMs</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">batchSize</span>&gt;</span>100<span class="hljs-tag">&lt;/<span class="hljs-name">batchSize</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">encoder</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.github.loki4j.logback.JsonEncoder"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">pattern</span>&gt;</span>app=my-app,host=${HOSTNAME},level=%level<span class="hljs-tag">&lt;/<span class="hljs-name">pattern</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">message</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">pattern</span>&gt;</span>l=%level h=${HOSTNAME} c=%logger{20} t=%thread | %msg %ex<span class="hljs-tag">&lt;/<span class="hljs-name">pattern</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">message</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">encoder</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">appender</span>&gt;</span>
</code></pre>
<p>we can re-write it for 1.0.0:</p>
<pre><code class="hljs css language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">appender</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"LOKI"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.github.loki4j.logback.Loki4jAppender"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">batchSize</span>&gt;</span>100<span class="hljs-tag">&lt;/<span class="hljs-name">batchSize</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">http</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.github.loki4j.logback.ApacheHttpSender"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">url</span>&gt;</span>http://localhost:3100/loki/api/v1/push<span class="hljs-tag">&lt;/<span class="hljs-name">url</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">requestTimeoutMs</span>&gt;</span>15000<span class="hljs-tag">&lt;/<span class="hljs-name">requestTimeoutMs</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">http</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">format</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">pattern</span>&gt;</span>app=my-app,host=${HOSTNAME},level=%level<span class="hljs-tag">&lt;/<span class="hljs-name">pattern</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">message</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">pattern</span>&gt;</span>l=%level h=${HOSTNAME} c=%logger{20} t=%thread | %msg %ex<span class="hljs-tag">&lt;/<span class="hljs-name">pattern</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">message</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">format</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">appender</span>&gt;</span>
</code></pre>
</span></div></article></div><div class="docs-prevnext"><a class="docs-prev button" href="/loki-logback-appender/docs/tracing"><span class="arrow-prev">← </span><span>Tracing</span></a><a class="docs-next button" href="/loki-logback-appender/docs/olddocs"><span>Old Docs</span><span class="arrow-next"> →</span></a></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#upgrading-from-13x-to-14x">Upgrading from 1.3.x to 1.4.x</a></li><li><a href="#upgrading-from-12x-to-13x">Upgrading from 1.2.x to 1.3.x</a></li><li><a href="#upgrading-from-11x-to-12x">Upgrading from 1.1.x to 1.2.x</a></li><li><a href="#upgrading-from-10x-to-11x">Upgrading from 1.0.x to 1.1.x</a></li><li><a href="#upgrading-from-04x-to-10x">Upgrading from 0.4.x to 1.0.x</a></li></ul></nav></div><footer class="nav-footer" id="footer"><section class="sitemap"><a href="/loki-logback-appender/" class="nav-home"><img src="/loki-logback-appender/img/logo.svg" alt="Loki4j Logback" width="66" height="58"/></a><div><h5>Docs</h5><a href="/loki-logback-appender/docs/configuration">Reference</a></div><div><h5>Community</h5><a class="github-button" href="https://github.com/loki4j/loki-logback-appender" data-icon="octicon-star" data-count-href="/loki4j/loki-logback-appender/stargazers" data-show-count="true" data-count-aria-label="# stargazers on GitHub" aria-label="Star this project on GitHub">Loki4j GitHub</a><div class="social"><a href="https://twitter.com/arnehaev" class="twitter-follow-button">Follow @arnehaev</a></div><a href="https://stackoverflow.com/questions/tagged/loki4j" target="_blank" rel="noreferrer noopener">Stack Overflow</a></div><div><h5>More</h5><a href="https://docusaurus.io/">Powered by Docusaurus</a></div></section><section class="copyright">Copyright © 2023 Anton Nehaev</section></footer></div><script>window.twttr=(function(d,s, id){var js,fjs=d.getElementsByTagName(s)[0],t=window.twttr||{};if(d.getElementById(id))return t;js=d.createElement(s);js.id=id;js.src='https://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js, fjs);t._e = [];t.ready = function(f) {t._e.push(f);};return t;}(document, 'script', 'twitter-wjs'));</script></body></html>